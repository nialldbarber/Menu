59d2792d06b4903115965479146ed150
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _AnimatedImplementation = _interopRequireDefault(require("../../Animated/AnimatedImplementation"));

var React = _interopRequireWildcard(require("react"));

var _StyleSheet = _interopRequireDefault(require("../../StyleSheet/StyleSheet"));

var _View = _interopRequireDefault(require("../View/View"));

var _Platform = _interopRequireDefault(require("../../Utilities/Platform"));

var _jsxRuntime = require("react/jsx-runtime");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2.default)(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2.default)(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2.default)(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var AnimatedView = _AnimatedImplementation.default.createAnimatedComponent(_View.default);

var ScrollViewStickyHeader = function (_React$Component) {
  (0, _inherits2.default)(ScrollViewStickyHeader, _React$Component);

  var _super = _createSuper(ScrollViewStickyHeader);

  function ScrollViewStickyHeader() {
    var _this;

    (0, _classCallCheck2.default)(this, ScrollViewStickyHeader);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _super.call.apply(_super, [this].concat(args));
    _this.state = {
      measured: false,
      layoutY: 0,
      layoutHeight: 0,
      nextHeaderLayoutY: _this.props.nextHeaderLayoutY,
      translateY: null
    };
    _this._translateY = null;
    _this._shouldRecreateTranslateY = true;
    _this._haveReceivedInitialZeroTranslateY = true;
    _this._debounceTimeout = _Platform.default.OS === 'android' ? 15 : 64;

    _this._onLayout = function (event) {
      var layoutY = event.nativeEvent.layout.y;
      var layoutHeight = event.nativeEvent.layout.height;
      var measured = true;

      if (layoutY !== _this.state.layoutY || layoutHeight !== _this.state.layoutHeight || measured !== _this.state.measured) {
        _this._shouldRecreateTranslateY = true;
      }

      _this.setState({
        measured: measured,
        layoutY: layoutY,
        layoutHeight: layoutHeight
      });

      _this.props.onLayout(event);

      var child = React.Children.only(_this.props.children);

      if (child.props.onLayout) {
        child.props.onLayout(event);
      }
    };

    _this._setComponentRef = function (ref) {
      _this._ref = ref;
    };

    return _this;
  }

  (0, _createClass2.default)(ScrollViewStickyHeader, [{
    key: "setNextHeaderY",
    value: function setNextHeaderY(y) {
      this._shouldRecreateTranslateY = true;
      this.setState({
        nextHeaderLayoutY: y
      });
    }
  }, {
    key: "UNSAFE_componentWillReceiveProps",
    value: function UNSAFE_componentWillReceiveProps(nextProps) {
      if (nextProps.scrollViewHeight !== this.props.scrollViewHeight || nextProps.scrollAnimatedValue !== this.props.scrollAnimatedValue || nextProps.inverted !== this.props.inverted) {
        this._shouldRecreateTranslateY = true;
      }
    }
  }, {
    key: "updateTranslateListener",
    value: function updateTranslateListener(translateY, isFabric) {
      var _this2 = this;

      if (this._translateY != null && this._animatedValueListenerId != null) {
        this._translateY.removeListener(this._animatedValueListenerId);
      }

      this._translateY = translateY;
      this._shouldRecreateTranslateY = false;

      if (!isFabric) {
        return;
      }

      if (!this._animatedValueListener) {
        this._animatedValueListener = function (_ref) {
          var value = _ref.value;

          if (value === 0 && !_this2._haveReceivedInitialZeroTranslateY) {
            _this2._haveReceivedInitialZeroTranslateY = true;
            return;
          }

          if (_this2._timer) {
            clearTimeout(_this2._timer);
          }

          _this2._timer = setTimeout(function () {
            if (value !== _this2.state.translateY) {
              _this2.setState({
                translateY: value
              });
            }
          }, _this2._debounceTimeout);
        };
      }

      if (this.state.translateY !== 0 && this.state.translateY != null) {
        this._haveReceivedInitialZeroTranslateY = false;
      }

      this._animatedValueListenerId = translateY.addListener(this._animatedValueListener);
    }
  }, {
    key: "render",
    value: function render() {
      var _this$_ref$_internalI, _this$_ref$_internalI2;

      var isFabric = !!(this._ref && (_this$_ref$_internalI = this._ref['_internalInstanceHandle']) != null && (_this$_ref$_internalI2 = _this$_ref$_internalI.stateNode) != null && _this$_ref$_internalI2.canonical);

      if (this._shouldRecreateTranslateY) {
        var _this$props = this.props,
            inverted = _this$props.inverted,
            scrollViewHeight = _this$props.scrollViewHeight;
        var _this$state = this.state,
            measured = _this$state.measured,
            layoutHeight = _this$state.layoutHeight,
            layoutY = _this$state.layoutY,
            nextHeaderLayoutY = _this$state.nextHeaderLayoutY;
        var inputRange = [-1, 0];
        var outputRange = [0, 0];

        if (measured) {
          if (inverted) {
            if (scrollViewHeight != null) {
              var stickStartPoint = layoutY + layoutHeight - scrollViewHeight;

              if (stickStartPoint > 0) {
                inputRange.push(stickStartPoint);
                outputRange.push(0);
                inputRange.push(stickStartPoint + 1);
                outputRange.push(1);
                var collisionPoint = (nextHeaderLayoutY || 0) - layoutHeight - scrollViewHeight;

                if (collisionPoint > stickStartPoint) {
                  inputRange.push(collisionPoint, collisionPoint + 1);
                  outputRange.push(collisionPoint - stickStartPoint, collisionPoint - stickStartPoint);
                }
              }
            }
          } else {
            inputRange.push(layoutY);
            outputRange.push(0);

            var _collisionPoint = (nextHeaderLayoutY || 0) - layoutHeight;

            if (_collisionPoint >= layoutY) {
              inputRange.push(_collisionPoint, _collisionPoint + 1);
              outputRange.push(_collisionPoint - layoutY, _collisionPoint - layoutY);
            } else {
              inputRange.push(layoutY + 1);
              outputRange.push(1);
            }
          }
        }

        this.updateTranslateListener(this.props.scrollAnimatedValue.interpolate({
          inputRange: inputRange,
          outputRange: outputRange
        }), isFabric);
      }

      var child = React.Children.only(this.props.children);
      var passthroughAnimatedPropExplicitValues = isFabric && this.state.translateY != null ? {
        style: {
          transform: [{
            translateY: this.state.translateY
          }]
        }
      } : null;
      return (0, _jsxRuntime.jsx)(AnimatedView, {
        collapsable: false,
        nativeID: this.props.nativeID,
        onLayout: this._onLayout,
        ref: this._setComponentRef,
        style: [child.props.style, styles.header, {
          transform: [{
            translateY: this._translateY
          }]
        }],
        passthroughAnimatedPropExplicitValues: passthroughAnimatedPropExplicitValues,
        children: React.cloneElement(child, {
          style: styles.fill,
          onLayout: undefined
        })
      });
    }
  }]);
  return ScrollViewStickyHeader;
}(React.Component);

var styles = _StyleSheet.default.create({
  header: {
    zIndex: 10,
    position: 'relative'
  },
  fill: {
    flex: 1
  }
});

module.exports = ScrollViewStickyHeader;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNjcm9sbFZpZXdTdGlja3lIZWFkZXIuanMiXSwibmFtZXMiOlsiQW5pbWF0ZWRWaWV3IiwiQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbiIsImNyZWF0ZUFuaW1hdGVkQ29tcG9uZW50IiwiVmlldyIsIlNjcm9sbFZpZXdTdGlja3lIZWFkZXIiLCJzdGF0ZSIsIm1lYXN1cmVkIiwibGF5b3V0WSIsImxheW91dEhlaWdodCIsIm5leHRIZWFkZXJMYXlvdXRZIiwicHJvcHMiLCJ0cmFuc2xhdGVZIiwiX3RyYW5zbGF0ZVkiLCJfc2hvdWxkUmVjcmVhdGVUcmFuc2xhdGVZIiwiX2hhdmVSZWNlaXZlZEluaXRpYWxaZXJvVHJhbnNsYXRlWSIsIl9kZWJvdW5jZVRpbWVvdXQiLCJQbGF0Zm9ybSIsIk9TIiwiX29uTGF5b3V0IiwiZXZlbnQiLCJuYXRpdmVFdmVudCIsImxheW91dCIsInkiLCJoZWlnaHQiLCJzZXRTdGF0ZSIsIm9uTGF5b3V0IiwiY2hpbGQiLCJSZWFjdCIsIkNoaWxkcmVuIiwib25seSIsImNoaWxkcmVuIiwiX3NldENvbXBvbmVudFJlZiIsInJlZiIsIl9yZWYiLCJuZXh0UHJvcHMiLCJzY3JvbGxWaWV3SGVpZ2h0Iiwic2Nyb2xsQW5pbWF0ZWRWYWx1ZSIsImludmVydGVkIiwiaXNGYWJyaWMiLCJfYW5pbWF0ZWRWYWx1ZUxpc3RlbmVySWQiLCJyZW1vdmVMaXN0ZW5lciIsIl9hbmltYXRlZFZhbHVlTGlzdGVuZXIiLCJ2YWx1ZSIsIl90aW1lciIsImNsZWFyVGltZW91dCIsInNldFRpbWVvdXQiLCJhZGRMaXN0ZW5lciIsInN0YXRlTm9kZSIsImNhbm9uaWNhbCIsImlucHV0UmFuZ2UiLCJvdXRwdXRSYW5nZSIsInN0aWNrU3RhcnRQb2ludCIsInB1c2giLCJjb2xsaXNpb25Qb2ludCIsInVwZGF0ZVRyYW5zbGF0ZUxpc3RlbmVyIiwiaW50ZXJwb2xhdGUiLCJwYXNzdGhyb3VnaEFuaW1hdGVkUHJvcEV4cGxpY2l0VmFsdWVzIiwic3R5bGUiLCJ0cmFuc2Zvcm0iLCJuYXRpdmVJRCIsInN0eWxlcyIsImhlYWRlciIsImNsb25lRWxlbWVudCIsImZpbGwiLCJ1bmRlZmluZWQiLCJDb21wb25lbnQiLCJTdHlsZVNoZWV0IiwiY3JlYXRlIiwiekluZGV4IiwicG9zaXRpb24iLCJmbGV4IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBVUE7Ozs7Ozs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7OztBQUlBLElBQU1BLFlBQVksR0FBR0MsZ0NBQXVCQyx1QkFBdkIsQ0FBK0NDLGFBQS9DLENBQXJCOztJQXlCTUMsc0I7Ozs7Ozs7Ozs7Ozs7OztVQUNKQyxLLEdBQWU7QUFDYkMsTUFBQUEsUUFBUSxFQUFFLEtBREc7QUFFYkMsTUFBQUEsT0FBTyxFQUFFLENBRkk7QUFHYkMsTUFBQUEsWUFBWSxFQUFFLENBSEQ7QUFJYkMsTUFBQUEsaUJBQWlCLEVBQUUsTUFBS0MsS0FBTCxDQUFXRCxpQkFKakI7QUFLYkUsTUFBQUEsVUFBVSxFQUFFO0FBTEMsSztVQVFmQyxXLEdBQXFELEk7VUFDckRDLHlCLEdBQXFDLEk7VUFDckNDLGtDLEdBQThDLEk7VUFPOUNDLGdCLEdBQTJCQyxrQkFBU0MsRUFBVCxLQUFnQixTQUFoQixHQUE0QixFQUE1QixHQUFpQyxFOztVQTBFNURDLFMsR0FBWSxVQUFBQyxLQUFLLEVBQUk7QUFDbkIsVUFBTVosT0FBTyxHQUFHWSxLQUFLLENBQUNDLFdBQU4sQ0FBa0JDLE1BQWxCLENBQXlCQyxDQUF6QztBQUNBLFVBQU1kLFlBQVksR0FBR1csS0FBSyxDQUFDQyxXQUFOLENBQWtCQyxNQUFsQixDQUF5QkUsTUFBOUM7QUFDQSxVQUFNakIsUUFBUSxHQUFHLElBQWpCOztBQUVBLFVBQ0VDLE9BQU8sS0FBSyxNQUFLRixLQUFMLENBQVdFLE9BQXZCLElBQ0FDLFlBQVksS0FBSyxNQUFLSCxLQUFMLENBQVdHLFlBRDVCLElBRUFGLFFBQVEsS0FBSyxNQUFLRCxLQUFMLENBQVdDLFFBSDFC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TixFQUFBQSxJQUFJLEVBQUU7QUFDSk8sSUFBQUEsSUFBSSxFQUFFO0FBREY7QUFMeUIsQ0FBbEIsQ0FBZjs7QUFVQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEUsc0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IEFuaW1hdGVkSW1wbGVtZW50YXRpb24gZnJvbSAnLi4vLi4vQW5pbWF0ZWQvQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbic7XG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgU3R5bGVTaGVldCBmcm9tICcuLi8uLi9TdHlsZVNoZWV0L1N0eWxlU2hlZXQnO1xuaW1wb3J0IFZpZXcgZnJvbSAnLi4vVmlldy9WaWV3JztcbmltcG9ydCBQbGF0Zm9ybSBmcm9tICcuLi8uLi9VdGlsaXRpZXMvUGxhdGZvcm0nO1xuXG5pbXBvcnQgdHlwZSB7TGF5b3V0RXZlbnR9IGZyb20gJy4uLy4uL1R5cGVzL0NvcmVFdmVudFR5cGVzJztcblxuY29uc3QgQW5pbWF0ZWRWaWV3ID0gQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbi5jcmVhdGVBbmltYXRlZENvbXBvbmVudChWaWV3KTtcblxuZXhwb3J0IHR5cGUgUHJvcHMgPSB7XG4gIGNoaWxkcmVuPzogUmVhY3QuRWxlbWVudDxhbnk+LFxuICBuZXh0SGVhZGVyTGF5b3V0WTogP251bWJlcixcbiAgb25MYXlvdXQ6IChldmVudDogTGF5b3V0RXZlbnQpID0+IHZvaWQsXG4gIHNjcm9sbEFuaW1hdGVkVmFsdWU6IEFuaW1hdGVkSW1wbGVtZW50YXRpb24uVmFsdWUsXG4gIC8vIFdpbGwgY2F1c2Ugc3RpY2t5IGhlYWRlcnMgdG8gc3RpY2sgYXQgdGhlIGJvdHRvbSBvZiB0aGUgU2Nyb2xsVmlldyBpbnN0ZWFkXG4gIC8vIG9mIHRoZSB0b3AuXG4gIGludmVydGVkOiA/Ym9vbGVhbixcbiAgLy8gVGhlIGhlaWdodCBvZiB0aGUgcGFyZW50IFNjcm9sbFZpZXcuIEN1cnJlbnRseSBvbmx5IHNldCB3aGVuIGludmVydGVkLlxuICBzY3JvbGxWaWV3SGVpZ2h0OiA/bnVtYmVyLFxuICBuYXRpdmVJRD86ID9zdHJpbmcsXG4gIC4uLlxufTtcblxudHlwZSBTdGF0ZSA9IHtcbiAgbWVhc3VyZWQ6IGJvb2xlYW4sXG4gIGxheW91dFk6IG51bWJlcixcbiAgbGF5b3V0SGVpZ2h0OiBudW1iZXIsXG4gIG5leHRIZWFkZXJMYXlvdXRZOiA/bnVtYmVyLFxuICB0cmFuc2xhdGVZOiA/bnVtYmVyLFxuICAuLi5cbn07XG5cbmNsYXNzIFNjcm9sbFZpZXdTdGlja3lIZWFkZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8UHJvcHMsIFN0YXRlPiB7XG4gIHN0YXRlOiBTdGF0ZSA9IHtcbiAgICBtZWFzdXJlZDogZmFsc2UsXG4gICAgbGF5b3V0WTogMCxcbiAgICBsYXlvdXRIZWlnaHQ6IDAsXG4gICAgbmV4dEhlYWRlckxheW91dFk6IHRoaXMucHJvcHMubmV4dEhlYWRlckxheW91dFksXG4gICAgdHJhbnNsYXRlWTogbnVsbCxcbiAgfTtcblxuICBfdHJhbnNsYXRlWTogP0FuaW1hdGVkSW1wbGVtZW50YXRpb24uSW50ZXJwb2xhdGlvbiA9IG51bGw7XG4gIF9zaG91bGRSZWNyZWF0ZVRyYW5zbGF0ZVk6IGJvb2xlYW4gPSB0cnVlO1xuICBfaGF2ZVJlY2VpdmVkSW5pdGlhbFplcm9UcmFuc2xhdGVZOiBib29sZWFuID0gdHJ1ZTtcbiAgX3JlZjogYW55OyAvLyBUT0RPIFQ1MzczODE2MTogZmxvdyB0eXBlIHRoaXMsIGFuZCB0aGUgd2hvbGUgZmlsZVxuXG4gIC8vIEZhYnJpYy1vbmx5OlxuICBfdGltZXI6ID9UaW1lb3V0SUQ7XG4gIF9hbmltYXRlZFZhbHVlTGlzdGVuZXJJZDogc3RyaW5nO1xuICBfYW5pbWF0ZWRWYWx1ZUxpc3RlbmVyOiAodmFsdWVPYmplY3Q6ICRSZWFkT25seTx7fHZhbHVlOiBudW1iZXJ8fT4pID0+IHZvaWQ7XG4gIF9kZWJvdW5jZVRpbWVvdXQ6IG51bWJlciA9IFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcgPyAxNSA6IDY0O1xuXG4gIHNldE5leHRIZWFkZXJZKHk6IG51bWJlcikge1xuICAgIHRoaXMuX3Nob3VsZFJlY3JlYXRlVHJhbnNsYXRlWSA9IHRydWU7XG4gICAgdGhpcy5zZXRTdGF0ZSh7bmV4dEhlYWRlckxheW91dFk6IHl9KTtcbiAgfVxuXG4gIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogUHJvcHMpIHtcbiAgICBpZiAoXG4gICAgICBuZXh0UHJvcHMuc2Nyb2xsVmlld0hlaWdodCAhPT0gdGhpcy5wcm9wcy5zY3JvbGxWaWV3SGVpZ2h0IHx8XG4gICAgICBuZXh0UHJvcHMuc2Nyb2xsQW5pbWF0ZWRWYWx1ZSAhPT0gdGhpcy5wcm9wcy5zY3JvbGxBbmltYXRlZFZhbHVlIHx8XG4gICAgICBuZXh0UHJvcHMuaW52ZXJ0ZWQgIT09IHRoaXMucHJvcHMuaW52ZXJ0ZWRcbiAgICApIHtcbiAgICAgIHRoaXMuX3Nob3VsZFJlY3JlYXRlVHJhbnNsYXRlWSA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlVHJhbnNsYXRlTGlzdGVuZXIoXG4gICAgdHJhbnNsYXRlWTogQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbi5JbnRlcnBvbGF0aW9uLFxuICAgIGlzRmFicmljOiBib29sZWFuLFxuICApIHtcbiAgICBpZiAodGhpcy5fdHJhbnNsYXRlWSAhPSBudWxsICYmIHRoaXMuX2FuaW1hdGVkVmFsdWVMaXN0ZW5lcklkICE9IG51bGwpIHtcbiAgICAgIHRoaXMuX3RyYW5zbGF0ZVkucmVtb3ZlTGlzdGVuZXIodGhpcy5fYW5pbWF0ZWRWYWx1ZUxpc3RlbmVySWQpO1xuICAgIH1cblxuICAgIHRoaXMuX3RyYW5zbGF0ZVkgPSB0cmFuc2xhdGVZO1xuICAgIHRoaXMuX3Nob3VsZFJlY3JlYXRlVHJhbnNsYXRlWSA9IGZhbHNlO1xuXG4gICAgaWYgKCFpc0ZhYnJpYykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5fYW5pbWF0ZWRWYWx1ZUxpc3RlbmVyKSB7XG4gICAgICAvLyBUaGlzIGlzIGNhbGxlZCB3aGVuZXZlciB0aGUgKEludGVycG9sYXRlZCkgQW5pbWF0ZWQgVmFsdWVcbiAgICAgIC8vIHVwZGF0ZXMsIHdoaWNoIGlzIHNldmVyYWwgdGltZXMgcGVyIGZyYW1lIGR1cmluZyBzY3JvbGxpbmcuXG4gICAgICAvLyBUbyBlbnN1cmUgdGhhdCB0aGUgRmFicmljIFNoYWRvd1RyZWUgaGFzIHRoZSBtb3N0IHJlY2VudFxuICAgICAgLy8gdHJhbnNsYXRlIHN0eWxlIG9mIHRoaXMgbm9kZSwgd2UgZGVib3VuY2UgdGhlIHZhbHVlIGFuZCB0aGVuXG4gICAgICAvLyBwYXNzIGl0IHRocm91Z2ggdG8gdGhlIHVuZGVybHlpbmcgbm9kZSBkdXJpbmcgcmVuZGVyLlxuICAgICAgLy8gVGhpcyBpczpcbiAgICAgIC8vIDEuIE9ubHkgYW4gaXNzdWUgaW4gRmFicmljLlxuICAgICAgLy8gMi4gV29yc2UgaW4gQW5kcm9pZCB0aGFuIGlPUy4gSW4gQW5kcm9pZCwgYnV0IG5vdCBpT1MsIHlvdVxuICAgICAgLy8gICAgY2FuIHRvdWNoIGFuZCBtb3ZlIHlvdXIgZmluZ2VyIHNsaWdodGx5IGFuZCBzdGlsbCB0cmlnZ2VyXG4gICAgICAvLyAgICBhIFwidGFwXCIgZXZlbnQuIEluIGlPUywgbW92aW5nIHdpbGwgY2FuY2VsIHRoZSB0YXAgaW5cbiAgICAgIC8vICAgIGJvdGggRmFicmljIGFuZCBub24tRmFicmljLiBPbiBBbmRyb2lkIHdoZW4geW91IG1vdmVcbiAgICAgIC8vICAgIHlvdXIgZmluZ2VyLCB0aGUgaGl0LWRldGVjdGlvbiBtb3ZlcyBmcm9tIHRoZSBBbmRyb2lkXG4gICAgICAvLyAgICBwbGF0Zm9ybSB0byBKUywgc28gd2UgbmVlZCB0aGUgU2hhZG93VHJlZSB0byBoYXZlIGtub3dsZWRnZVxuICAgICAgLy8gICAgb2YgdGhlIGN1cnJlbnQgcG9zaXRpb24uXG4gICAgICB0aGlzLl9hbmltYXRlZFZhbHVlTGlzdGVuZXIgPSAoe3ZhbHVlfSkgPT4ge1xuICAgICAgICAvLyBXaGVuIHRoZSBBbmltYXRlZEludGVycG9sYXRpb24gaXMgcmVjcmVhdGVkLCBpdCBhbHdheXMgaW5pdGlhbGl6ZXNcbiAgICAgICAgLy8gdG8gYSB2YWx1ZSBvZiB6ZXJvIGFuZCBlbWl0cyBhIHZhbHVlIGNoYW5nZSBvZiAwIHRvIGl0cyBsaXN0ZW5lcnMuXG4gICAgICAgIGlmICh2YWx1ZSA9PT0gMCAmJiAhdGhpcy5faGF2ZVJlY2VpdmVkSW5pdGlhbFplcm9UcmFuc2xhdGVZKSB7XG4gICAgICAgICAgdGhpcy5faGF2ZVJlY2VpdmVkSW5pdGlhbFplcm9UcmFuc2xhdGVZID0gdHJ1ZTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuX3RpbWVyKSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl90aW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy5zdGF0ZS50cmFuc2xhdGVZKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgdHJhbnNsYXRlWTogdmFsdWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIHRoaXMuX2RlYm91bmNlVGltZW91dCk7XG4gICAgICB9O1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0ZS50cmFuc2xhdGVZICE9PSAwICYmIHRoaXMuc3RhdGUudHJhbnNsYXRlWSAhPSBudWxsKSB7XG4gICAgICB0aGlzLl9oYXZlUmVjZWl2ZWRJbml0aWFsWmVyb1RyYW5zbGF0ZVkgPSBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5fYW5pbWF0ZWRWYWx1ZUxpc3RlbmVySWQgPSB0cmFuc2xhdGVZLmFkZExpc3RlbmVyKFxuICAgICAgdGhpcy5fYW5pbWF0ZWRWYWx1ZUxpc3RlbmVyLFxuICAgICk7XG4gIH1cblxuICBfb25MYXlvdXQgPSBldmVudCA9PiB7XG4gICAgY29uc3QgbGF5b3V0WSA9IGV2ZW50Lm5hdGl2ZUV2ZW50LmxheW91dC55O1xuICAgIGNvbnN0IGxheW91dEhlaWdodCA9IGV2ZW50Lm5hdGl2ZUV2ZW50LmxheW91dC5oZWlnaHQ7XG4gICAgY29uc3QgbWVhc3VyZWQgPSB0cnVlO1xuXG4gICAgaWYgKFxuICAgICAgbGF5b3V0WSAhPT0gdGhpcy5zdGF0ZS5sYXlvdXRZIHx8XG4gICAgICBsYXlvdXRIZWlnaHQgIT09IHRoaXMuc3RhdGUubGF5b3V0SGVpZ2h0IHx8XG4gICAgICBtZWFzdXJlZCAhPT0gdGhpcy5zdGF0ZS5tZWFzdXJlZFxuICAgICkge1xuICAgICAgdGhpcy5fc2hvdWxkUmVjcmVhdGVUcmFuc2xhdGVZID0gdHJ1ZTtcbiAgICB9XG5cbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIG1lYXN1cmVkLFxuICAgICAgbGF5b3V0WSxcbiAgICAgIGxheW91dEhlaWdodCxcbiAgICB9KTtcblxuICAgIHRoaXMucHJvcHMub25MYXlvdXQoZXZlbnQpO1xuICAgIGNvbnN0IGNoaWxkID0gUmVhY3QuQ2hpbGRyZW4ub25seSh0aGlzLnByb3BzLmNoaWxkcmVuKTtcbiAgICBpZiAoY2hpbGQucHJvcHMub25MYXlvdXQpIHtcbiAgICAgIGNoaWxkLnByb3BzLm9uTGF5b3V0KGV2ZW50KTtcbiAgICB9XG4gIH07XG5cbiAgX3NldENvbXBvbmVudFJlZiA9IHJlZiA9PiB7XG4gICAgdGhpcy5fcmVmID0gcmVmO1xuICB9O1xuXG4gIHJlbmRlcigpOiBSZWFjdC5Ob2RlIHtcbiAgICAvLyBGYWJyaWMgRGV0ZWN0aW9uXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGRvdC1ub3RhdGlvblxuICAgIGNvbnN0IGlzRmFicmljID0gISEoXG4gICAgICB0aGlzLl9yZWYgJiYgdGhpcy5fcmVmWydfaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSddPy5zdGF0ZU5vZGU/LmNhbm9uaWNhbFxuICAgICk7XG5cbiAgICAvLyBJbml0aWFsbHkgYW5kIGluIHRoZSBjYXNlIG9mIHVwZGF0ZWQgcHJvcHMgb3IgbGF5b3V0LCB3ZVxuICAgIC8vIHJlY3JlYXRlIHRoaXMgaW50ZXJwb2xhdGVkIHZhbHVlLiBPdGhlcndpc2UsIHdlIGRvIG5vdCByZWNyZWF0ZVxuICAgIC8vIHdoZW4gdGhlcmUgYXJlIHN0YXRlIGNoYW5nZXMuXG4gICAgaWYgKHRoaXMuX3Nob3VsZFJlY3JlYXRlVHJhbnNsYXRlWSkge1xuICAgICAgY29uc3Qge2ludmVydGVkLCBzY3JvbGxWaWV3SGVpZ2h0fSA9IHRoaXMucHJvcHM7XG4gICAgICBjb25zdCB7bWVhc3VyZWQsIGxheW91dEhlaWdodCwgbGF5b3V0WSwgbmV4dEhlYWRlckxheW91dFl9ID0gdGhpcy5zdGF0ZTtcbiAgICAgIGNvbnN0IGlucHV0UmFuZ2U6IEFycmF5PG51bWJlcj4gPSBbLTEsIDBdO1xuICAgICAgY29uc3Qgb3V0cHV0UmFuZ2U6IEFycmF5PG51bWJlcj4gPSBbMCwgMF07XG5cbiAgICAgIGlmIChtZWFzdXJlZCkge1xuICAgICAgICBpZiAoaW52ZXJ0ZWQpIHtcbiAgICAgICAgICAvLyBUaGUgaW50ZXJwb2xhdGlvbiBsb29rcyBsaWtlOlxuICAgICAgICAgIC8vIC0gTmVnYXRpdmUgc2Nyb2xsOiBubyB0cmFuc2xhdGlvblxuICAgICAgICAgIC8vIC0gYHN0aWNrU3RhcnRQb2ludGAgaXMgdGhlIHBvaW50IGF0IHdoaWNoIHRoZSBoZWFkZXIgd2lsbCBzdGFydCBzdGlja2luZy5cbiAgICAgICAgICAvLyAgIEl0IGlzIGNhbGN1bGF0ZWQgdXNpbmcgdGhlIFNjcm9sbFZpZXcgdmlld3BvcnQgaGVpZ2h0IHNvIGl0IGlzIGEgdGhlIGJvdHRvbS5cbiAgICAgICAgICAvLyAtIEhlYWRlcnMgdGhhdCBhcmUgaW4gdGhlIGluaXRpYWwgdmlld3BvcnQgd2lsbCBuZXZlciBzdGljaywgYHN0aWNrU3RhcnRQb2ludGBcbiAgICAgICAgICAvLyAgIHdpbGwgYmUgbmVnYXRpdmUuXG4gICAgICAgICAgLy8gLSBGcm9tIDAgdG8gYHN0aWNrU3RhcnRQb2ludGAgbm8gdHJhbnNsYXRpb24uIFRoaXMgd2lsbCBjYXVzZSB0aGUgaGVhZGVyXG4gICAgICAgICAgLy8gICB0byBzY3JvbGwgbm9ybWFsbHkgdW50aWwgaXQgcmVhY2hlcyB0aGUgdG9wIG9mIHRoZSBzY3JvbGwgdmlldy5cbiAgICAgICAgICAvLyAtIEZyb20gYHN0aWNrU3RhcnRQb2ludGAgdG8gd2hlbiB0aGUgbmV4dCBoZWFkZXIgeSBoaXRzIHRoZSBib3R0b20gZWRnZSBvZiB0aGUgaGVhZGVyOiB0cmFuc2xhdGVcbiAgICAgICAgICAvLyAgIGVxdWFsbHkgdG8gc2Nyb2xsLiBUaGlzIHdpbGwgY2F1c2UgdGhlIGhlYWRlciB0byBzdGF5IGF0IHRoZSB0b3Agb2YgdGhlIHNjcm9sbCB2aWV3LlxuICAgICAgICAgIC8vIC0gUGFzdCB0aGUgY29sbGlzaW9uIHdpdGggdGhlIG5leHQgaGVhZGVyIHk6IG5vIG1vcmUgdHJhbnNsYXRpb24uIFRoaXMgd2lsbCBjYXVzZSB0aGVcbiAgICAgICAgICAvLyAgIGhlYWRlciB0byBjb250aW51ZSBzY3JvbGxpbmcgdXAgYW5kIG1ha2Ugcm9vbSBmb3IgdGhlIG5leHQgc3RpY2t5IGhlYWRlci5cbiAgICAgICAgICAvLyAgIEluIHRoZSBjYXNlIHRoYXQgdGhlcmUgaXMgbm8gbmV4dCBoZWFkZXIganVzdCB0cmFuc2xhdGUgZXF1YWxseSB0b1xuICAgICAgICAgIC8vICAgc2Nyb2xsIGluZGVmaW5pdGVseS5cbiAgICAgICAgICBpZiAoc2Nyb2xsVmlld0hlaWdodCAhPSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCBzdGlja1N0YXJ0UG9pbnQgPSBsYXlvdXRZICsgbGF5b3V0SGVpZ2h0IC0gc2Nyb2xsVmlld0hlaWdodDtcbiAgICAgICAgICAgIGlmIChzdGlja1N0YXJ0UG9pbnQgPiAwKSB7XG4gICAgICAgICAgICAgIGlucHV0UmFuZ2UucHVzaChzdGlja1N0YXJ0UG9pbnQpO1xuICAgICAgICAgICAgICBvdXRwdXRSYW5nZS5wdXNoKDApO1xuICAgICAgICAgICAgICBpbnB1dFJhbmdlLnB1c2goc3RpY2tTdGFydFBvaW50ICsgMSk7XG4gICAgICAgICAgICAgIG91dHB1dFJhbmdlLnB1c2goMSk7XG4gICAgICAgICAgICAgIC8vIElmIHRoZSBuZXh0IHN0aWNreSBoZWFkZXIgaGFzIG5vdCBsb2FkZWQgeWV0IChwcm9iYWJseSB3aW5kb3dpbmcpIG9yIGlzIHRoZSBsYXN0XG4gICAgICAgICAgICAgIC8vIHdlIGNhbiBqdXN0IGtlZXAgaXQgc3RpY2tlZCBmb3JldmVyLlxuICAgICAgICAgICAgICBjb25zdCBjb2xsaXNpb25Qb2ludCA9XG4gICAgICAgICAgICAgICAgKG5leHRIZWFkZXJMYXlvdXRZIHx8IDApIC0gbGF5b3V0SGVpZ2h0IC0gc2Nyb2xsVmlld0hlaWdodDtcbiAgICAgICAgICAgICAgaWYgKGNvbGxpc2lvblBvaW50ID4gc3RpY2tTdGFydFBvaW50KSB7XG4gICAgICAgICAgICAgICAgaW5wdXRSYW5nZS5wdXNoKGNvbGxpc2lvblBvaW50LCBjb2xsaXNpb25Qb2ludCArIDEpO1xuICAgICAgICAgICAgICAgIG91dHB1dFJhbmdlLnB1c2goXG4gICAgICAgICAgICAgICAgICBjb2xsaXNpb25Qb2ludCAtIHN0aWNrU3RhcnRQb2ludCxcbiAgICAgICAgICAgICAgICAgIGNvbGxpc2lvblBvaW50IC0gc3RpY2tTdGFydFBvaW50LFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gVGhlIGludGVycG9sYXRpb24gbG9va3MgbGlrZTpcbiAgICAgICAgICAvLyAtIE5lZ2F0aXZlIHNjcm9sbDogbm8gdHJhbnNsYXRpb25cbiAgICAgICAgICAvLyAtIEZyb20gMCB0byB0aGUgeSBvZiB0aGUgaGVhZGVyOiBubyB0cmFuc2xhdGlvbi4gVGhpcyB3aWxsIGNhdXNlIHRoZSBoZWFkZXJcbiAgICAgICAgICAvLyAgIHRvIHNjcm9sbCBub3JtYWxseSB1bnRpbCBpdCByZWFjaGVzIHRoZSB0b3Agb2YgdGhlIHNjcm9sbCB2aWV3LlxuICAgICAgICAgIC8vIC0gRnJvbSBoZWFkZXIgeSB0byB3aGVuIHRoZSBuZXh0IGhlYWRlciB5IGhpdHMgdGhlIGJvdHRvbSBlZGdlIG9mIHRoZSBoZWFkZXI6IHRyYW5zbGF0ZVxuICAgICAgICAgIC8vICAgZXF1YWxseSB0byBzY3JvbGwuIFRoaXMgd2lsbCBjYXVzZSB0aGUgaGVhZGVyIHRvIHN0YXkgYXQgdGhlIHRvcCBvZiB0aGUgc2Nyb2xsIHZpZXcuXG4gICAgICAgICAgLy8gLSBQYXN0IHRoZSBjb2xsaXNpb24gd2l0aCB0aGUgbmV4dCBoZWFkZXIgeTogbm8gbW9yZSB0cmFuc2xhdGlvbi4gVGhpcyB3aWxsIGNhdXNlIHRoZVxuICAgICAgICAgIC8vICAgaGVhZGVyIHRvIGNvbnRpbnVlIHNjcm9sbGluZyB1cCBhbmQgbWFrZSByb29tIGZvciB0aGUgbmV4dCBzdGlja3kgaGVhZGVyLlxuICAgICAgICAgIC8vICAgSW4gdGhlIGNhc2UgdGhhdCB0aGVyZSBpcyBubyBuZXh0IGhlYWRlciBqdXN0IHRyYW5zbGF0ZSBlcXVhbGx5IHRvXG4gICAgICAgICAgLy8gICBzY3JvbGwgaW5kZWZpbml0ZWx5LlxuICAgICAgICAgIGlucHV0UmFuZ2UucHVzaChsYXlvdXRZKTtcbiAgICAgICAgICBvdXRwdXRSYW5nZS5wdXNoKDApO1xuICAgICAgICAgIC8vIElmIHRoZSBuZXh0IHN0aWNreSBoZWFkZXIgaGFzIG5vdCBsb2FkZWQgeWV0IChwcm9iYWJseSB3aW5kb3dpbmcpIG9yIGlzIHRoZSBsYXN0XG4gICAgICAgICAgLy8gd2UgY2FuIGp1c3Qga2VlcCBpdCBzdGlja2VkIGZvcmV2ZXIuXG4gICAgICAgICAgY29uc3QgY29sbGlzaW9uUG9pbnQgPSAobmV4dEhlYWRlckxheW91dFkgfHwgMCkgLSBsYXlvdXRIZWlnaHQ7XG4gICAgICAgICAgaWYgKGNvbGxpc2lvblBvaW50ID49IGxheW91dFkpIHtcbiAgICAgICAgICAgIGlucHV0UmFuZ2UucHVzaChjb2xsaXNpb25Qb2ludCwgY29sbGlzaW9uUG9pbnQgKyAxKTtcbiAgICAgICAgICAgIG91dHB1dFJhbmdlLnB1c2goXG4gICAgICAgICAgICAgIGNvbGxpc2lvblBvaW50IC0gbGF5b3V0WSxcbiAgICAgICAgICAgICAgY29sbGlzaW9uUG9pbnQgLSBsYXlvdXRZLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaW5wdXRSYW5nZS5wdXNoKGxheW91dFkgKyAxKTtcbiAgICAgICAgICAgIG91dHB1dFJhbmdlLnB1c2goMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMudXBkYXRlVHJhbnNsYXRlTGlzdGVuZXIoXG4gICAgICAgIHRoaXMucHJvcHMuc2Nyb2xsQW5pbWF0ZWRWYWx1ZS5pbnRlcnBvbGF0ZSh7XG4gICAgICAgICAgaW5wdXRSYW5nZSxcbiAgICAgICAgICBvdXRwdXRSYW5nZSxcbiAgICAgICAgfSksXG4gICAgICAgIGlzRmFicmljLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGlsZCA9IFJlYWN0LkNoaWxkcmVuLm9ubHkodGhpcy5wcm9wcy5jaGlsZHJlbik7XG5cbiAgICAvLyBUT0RPIFQ2ODMxOTUzNTogcmVtb3ZlIHRoaXMgaWYgTmF0aXZlQW5pbWF0ZWQgaXMgcmV3cml0dGVuIGZvciBGYWJyaWNcbiAgICBjb25zdCBwYXNzdGhyb3VnaEFuaW1hdGVkUHJvcEV4cGxpY2l0VmFsdWVzID1cbiAgICAgIGlzRmFicmljICYmIHRoaXMuc3RhdGUudHJhbnNsYXRlWSAhPSBudWxsXG4gICAgICAgID8ge1xuICAgICAgICAgICAgc3R5bGU6IHt0cmFuc2Zvcm06IFt7dHJhbnNsYXRlWTogdGhpcy5zdGF0ZS50cmFuc2xhdGVZfV19LFxuICAgICAgICAgIH1cbiAgICAgICAgOiBudWxsO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxBbmltYXRlZFZpZXdcbiAgICAgICAgY29sbGFwc2FibGU9e2ZhbHNlfVxuICAgICAgICBuYXRpdmVJRD17dGhpcy5wcm9wcy5uYXRpdmVJRH1cbiAgICAgICAgb25MYXlvdXQ9e3RoaXMuX29uTGF5b3V0fVxuICAgICAgICByZWY9e3RoaXMuX3NldENvbXBvbmVudFJlZn1cbiAgICAgICAgc3R5bGU9e1tcbiAgICAgICAgICBjaGlsZC5wcm9wcy5zdHlsZSxcbiAgICAgICAgICBzdHlsZXMuaGVhZGVyLFxuICAgICAgICAgIHt0cmFuc2Zvcm06IFt7dHJhbnNsYXRlWTogdGhpcy5fdHJhbnNsYXRlWX1dfSxcbiAgICAgICAgXX1cbiAgICAgICAgcGFzc3Rocm91Z2hBbmltYXRlZFByb3BFeHBsaWNpdFZhbHVlcz17XG4gICAgICAgICAgcGFzc3Rocm91Z2hBbmltYXRlZFByb3BFeHBsaWNpdFZhbHVlc1xuICAgICAgICB9PlxuICAgICAgICB7UmVhY3QuY2xvbmVFbGVtZW50KGNoaWxkLCB7XG4gICAgICAgICAgc3R5bGU6IHN0eWxlcy5maWxsLCAvLyBXZSB0cmFuc2ZlciB0aGUgY2hpbGQgc3R5bGUgdG8gdGhlIHdyYXBwZXIuXG4gICAgICAgICAgb25MYXlvdXQ6IHVuZGVmaW5lZCwgLy8gd2UgY2FsbCB0aGlzIG1hbnVhbGx5IHRocm91Z2ggb3VyIHRoaXMuX29uTGF5b3V0XG4gICAgICAgIH0pfVxuICAgICAgPC9BbmltYXRlZFZpZXc+XG4gICAgKTtcbiAgfVxufVxuXG5jb25zdCBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7XG4gIGhlYWRlcjoge1xuICAgIHpJbmRleDogMTAsXG4gICAgcG9zaXRpb246ICdyZWxhdGl2ZScsXG4gIH0sXG4gIGZpbGw6IHtcbiAgICBmbGV4OiAxLFxuICB9LFxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gU2Nyb2xsVmlld1N0aWNreUhlYWRlcjtcbiJdfQ==