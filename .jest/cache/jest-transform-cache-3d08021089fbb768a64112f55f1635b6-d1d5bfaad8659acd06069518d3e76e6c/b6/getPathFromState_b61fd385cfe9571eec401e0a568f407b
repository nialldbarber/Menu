b800a14d760cb6f23f108b6d41f09d4f
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _toConsumableArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault2(require("@babel/runtime/helpers/defineProperty"));

var _extends2 = _interopRequireDefault2(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/slicedToArray"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = getPathFromState;

var queryString = _interopRequireWildcard(require("query-string"));

var _fromEntries = _interopRequireDefault(require("./fromEntries"));

var _validatePathConfig = _interopRequireDefault(require("./validatePathConfig"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _getRequireWildcardCache(nodeInterop) {
  if (typeof WeakMap !== "function") return null;
  var cacheBabelInterop = new WeakMap();
  var cacheNodeInterop = new WeakMap();
  return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) {
    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;
  })(nodeInterop);
}

function _interopRequireWildcard(obj, nodeInterop) {
  if (!nodeInterop && obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache(nodeInterop);

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

var getActiveRoute = function getActiveRoute(state) {
  var route = typeof state.index === 'number' ? state.routes[state.index] : state.routes[state.routes.length - 1];

  if (route.state) {
    return getActiveRoute(route.state);
  }

  return route;
};

function getPathFromState(state, options) {
  if (state == null) {
    throw Error("Got 'undefined' for the navigation state. You must pass a valid state object.");
  }

  if (options) {
    (0, _validatePathConfig.default)(options);
  }

  var configs = options !== null && options !== void 0 && options.screens ? createNormalizedConfigs(options === null || options === void 0 ? void 0 : options.screens) : {};
  var path = '/';
  var current = state;
  var allParams = {};

  var _loop = function _loop() {
    var index = typeof current.index === 'number' ? current.index : 0;
    var route = current.routes[index];
    var pattern = void 0;
    var focusedParams = void 0;
    var focusedRoute = getActiveRoute(state);
    var currentOptions = configs;
    var nestedRouteNames = [];
    var hasNext = true;

    while (route.name in currentOptions && hasNext) {
      pattern = currentOptions[route.name].pattern;
      nestedRouteNames.push(route.name);

      if (route.params) {
        (function () {
          var stringify = (_currentOptions$route = currentOptions[route.name]) === null || _currentOptions$route === void 0 ? void 0 : _currentOptions$route.stringify;
          var currentParams = (0, _fromEntries.default)(Object.entries(route.params).map(function (_ref) {
            var _ref2 = (0, _slicedToArray2.default)(_ref, 2),
                key = _ref2[0],
                value = _ref2[1];

            return [key, stringify !== null && stringify !== void 0 && stringify[key] ? stringify[key](value) : String(value)];
          }));

          if (pattern) {
            (0, _extends2.default)(allParams, currentParams);
          }

          if (focusedRoute === route) {
            focusedParams = _objectSpread({}, currentParams);
            (_pattern = pattern) === null || _pattern === void 0 ? void 0 : _pattern.split('/').filter(function (p) {
              return p.startsWith(':');
            }).forEach(function (p) {
              var name = getParamName(p);

              if (focusedParams) {
                delete focusedParams[name];
              }
            });
          }
        })();
      }

      if (!currentOptions[route.name].screens || route.state === undefined) {
        hasNext = false;
      } else {
        index = typeof route.state.index === 'number' ? route.state.index : route.state.routes.length - 1;
        var nextRoute = route.state.routes[index];
        var nestedConfig = currentOptions[route.name].screens;

        if (nestedConfig && nextRoute.name in nestedConfig) {
          route = nextRoute;
          currentOptions = nestedConfig;
        } else {
          hasNext = false;
        }
      }
    }

    if (pattern === undefined) {
      pattern = nestedRouteNames.join('/');
    }

    if (currentOptions[route.name] !== undefined) {
      path += pattern.split('/').map(function (p) {
        var name = getParamName(p);

        if (p === '*') {
          return route.name;
        }

        if (p.startsWith(':')) {
          var value = allParams[name];

          if (value === undefined && p.endsWith('?')) {
            return '';
          }

          return encodeURIComponent(value);
        }

        return encodeURIComponent(p);
      }).join('/');
    } else {
      path += encodeURIComponent(route.name);
    }

    if (!focusedParams) {
      focusedParams = focusedRoute.params;
    }

    if (route.state) {
      path += '/';
    } else if (focusedParams) {
      for (var param in focusedParams) {
        if (focusedParams[param] === 'undefined') {
          delete focusedParams[param];
        }
      }

      var query = queryString.stringify(focusedParams, {
        sort: false
      });

      if (query) {
        path += "?" + query;
      }
    }

    current = route.state;
  };

  while (current) {
    var _currentOptions$route;

    var _pattern;

    _loop();
  }

  path = path.replace(/\/+/g, '/');
  path = path.length > 1 ? path.replace(/\/$/, '') : path;
  return path;
}

var getParamName = function getParamName(pattern) {
  return pattern.replace(/^:/, '').replace(/\?$/, '');
};

var joinPaths = function joinPaths() {
  var _ref3;

  for (var _len = arguments.length, paths = new Array(_len), _key = 0; _key < _len; _key++) {
    paths[_key] = arguments[_key];
  }

  return (_ref3 = []).concat.apply(_ref3, (0, _toConsumableArray2.default)(paths.map(function (p) {
    return p.split('/');
  }))).filter(Boolean).join('/');
};

var createConfigItem = function createConfigItem(config, parentPattern) {
  var _pattern2;

  if (typeof config === 'string') {
    var _pattern3 = parentPattern ? joinPaths(parentPattern, config) : config;

    return {
      pattern: _pattern3
    };
  }

  var pattern;

  if (config.exact && config.path === undefined) {
    throw new Error("A 'path' needs to be specified when specifying 'exact: true'. If you don't want this screen in the URL, specify it as empty string, e.g. `path: ''`.");
  }

  pattern = config.exact !== true ? joinPaths(parentPattern || '', config.path || '') : config.path || '';
  var screens = config.screens ? createNormalizedConfigs(config.screens, pattern) : undefined;
  return {
    pattern: (_pattern2 = pattern) === null || _pattern2 === void 0 ? void 0 : _pattern2.split('/').filter(Boolean).join('/'),
    stringify: config.stringify,
    screens: screens
  };
};

var createNormalizedConfigs = function createNormalizedConfigs(options, pattern) {
  return (0, _fromEntries.default)(Object.entries(options).map(function (_ref4) {
    var _ref5 = (0, _slicedToArray2.default)(_ref4, 2),
        name = _ref5[0],
        c = _ref5[1];

    var result = createConfigItem(c, pattern);
    return [name, result];
  }));
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdldFBhdGhGcm9tU3RhdGUudHN4Il0sIm5hbWVzIjpbImdldEFjdGl2ZVJvdXRlIiwic3RhdGUiLCJyb3V0ZSIsIkVycm9yIiwiY29uZmlncyIsIm9wdGlvbnMiLCJjcmVhdGVOb3JtYWxpemVkQ29uZmlncyIsInBhdGgiLCJjdXJyZW50IiwiYWxsUGFyYW1zIiwiaW5kZXgiLCJwYXR0ZXJuIiwiZm9jdXNlZFBhcmFtcyIsImZvY3VzZWRSb3V0ZSIsImN1cnJlbnRPcHRpb25zIiwibmVzdGVkUm91dGVOYW1lcyIsImhhc05leHQiLCJzdHJpbmdpZnkiLCJjdXJyZW50UGFyYW1zIiwiT2JqZWN0IiwiU3RyaW5nIiwicCIsIm5hbWUiLCJnZXRQYXJhbU5hbWUiLCJuZXh0Um91dGUiLCJuZXN0ZWRDb25maWciLCJ2YWx1ZSIsImVuY29kZVVSSUNvbXBvbmVudCIsInF1ZXJ5Iiwic29ydCIsImpvaW5QYXRocyIsInBhdGhzIiwiY3JlYXRlQ29uZmlnSXRlbSIsInBhcmVudFBhdHRlcm4iLCJjb25maWciLCJzY3JlZW5zIiwicmVzdWx0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFLQSxJQUFBLFdBQUEsR0FBQSx1QkFBQSxDQUFBLE9BQUEsQ0FBQSxjQUFBLENBQUEsQ0FBQTs7QUFFQSxJQUFBLFlBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsaUJBQUEsQ0FBQTs7QUFFQSxJQUFBLG1CQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLHdCQUFBLENBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsSUFBTUEsY0FBYyxHQUFJQyxTQUFsQkQsY0FBa0JDLENBQUFBLEtBQUQsRUFBcUQ7QUFDMUUsTUFBTUMsS0FBSyxHQUNULE9BQU9ELEtBQUssQ0FBWixLQUFBLEtBQUEsUUFBQSxHQUNJQSxLQUFLLENBQUxBLE1BQUFBLENBQWFBLEtBQUssQ0FEdEIsS0FDSUEsQ0FESixHQUVJ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QUFBO0FBSUEsU0FBTztBQUVMdkIsSUFBQUEsT0FBTyxFQUFBLENBQUEsU0FBQSxHQUFBLE9BQUEsTUFBQSxJQUFBLElBQUEsU0FBQSxLQUFBLEtBQUEsQ0FBQSxHQUFBLEtBQUEsQ0FBQSxHQUFFQSxTQUFBQSxDQUFBQSxLQUFBQSxDQUFBQSxHQUFBQSxFQUFBQSxNQUFBQSxDQUFBQSxPQUFBQSxFQUFBQSxJQUFBQSxDQUZKLEdBRUlBLENBRko7QUFHTE0sSUFBQUEsU0FBUyxFQUFFaUIsTUFBTSxDQUhaLFNBQUE7QUFJTEMsSUFBQUEsT0FBQUEsRUFBQUE7QUFKSyxHQUFQO0FBOUJGLENBQUE7O0FBc0NBLElBQU03Qix1QkFBdUIsR0FBRyxTQUExQkEsdUJBQTBCLENBQUEsT0FBQSxFQUFBLE9BQUE7QUFBQSxTQUk5QixDQUFBLEdBQUEsWUFBQSxDQUFBLE9BQUEsRUFDRSxNQUFNLENBQU4sT0FBQSxDQUFBLE9BQUEsRUFBQSxHQUFBLENBQTRCLGlCQUFlO0FBQUE7QUFBQSxRQUFkLElBQWM7QUFBQSxRQUFmLENBQWU7O0FBQ3pDLFFBQU04QixNQUFNLEdBQUdKLGdCQUFnQixDQUFBLENBQUEsRUFBL0IsT0FBK0IsQ0FBL0I7QUFFQSxXQUFPLENBQUEsSUFBQSxFQUFQLE1BQU8sQ0FBUDtBQVJOLEdBS0ksQ0FERixDQUo4QjtBQUFBLENBQWhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge1xuICBOYXZpZ2F0aW9uU3RhdGUsXG4gIFBhcnRpYWxTdGF0ZSxcbiAgUm91dGUsXG59IGZyb20gJ0ByZWFjdC1uYXZpZ2F0aW9uL3JvdXRlcnMnO1xuaW1wb3J0ICogYXMgcXVlcnlTdHJpbmcgZnJvbSAncXVlcnktc3RyaW5nJztcblxuaW1wb3J0IGZyb21FbnRyaWVzIGZyb20gJy4vZnJvbUVudHJpZXMnO1xuaW1wb3J0IHR5cGUgeyBQYXRoQ29uZmlnLCBQYXRoQ29uZmlnTWFwIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgdmFsaWRhdGVQYXRoQ29uZmlnIGZyb20gJy4vdmFsaWRhdGVQYXRoQ29uZmlnJztcblxudHlwZSBPcHRpb25zPFBhcmFtTGlzdD4gPSB7XG4gIGluaXRpYWxSb3V0ZU5hbWU/OiBzdHJpbmc7XG4gIHNjcmVlbnM6IFBhdGhDb25maWdNYXA8UGFyYW1MaXN0Pjtcbn07XG5cbnR5cGUgU3RhdGUgPSBOYXZpZ2F0aW9uU3RhdGUgfCBPbWl0PFBhcnRpYWxTdGF0ZTxOYXZpZ2F0aW9uU3RhdGU+LCAnc3RhbGUnPjtcblxudHlwZSBTdHJpbmdpZnlDb25maWcgPSBSZWNvcmQ8c3RyaW5nLCAodmFsdWU6IGFueSkgPT4gc3RyaW5nPjtcblxudHlwZSBDb25maWdJdGVtID0ge1xuICBwYXR0ZXJuPzogc3RyaW5nO1xuICBzdHJpbmdpZnk/OiBTdHJpbmdpZnlDb25maWc7XG4gIHNjcmVlbnM/OiBSZWNvcmQ8c3RyaW5nLCBDb25maWdJdGVtPjtcbn07XG5cbmNvbnN0IGdldEFjdGl2ZVJvdXRlID0gKHN0YXRlOiBTdGF0ZSk6IHsgbmFtZTogc3RyaW5nOyBwYXJhbXM/OiBvYmplY3QgfSA9PiB7XG4gIGNvbnN0IHJvdXRlID1cbiAgICB0eXBlb2Ygc3RhdGUuaW5kZXggPT09ICdudW1iZXInXG4gICAgICA/IHN0YXRlLnJvdXRlc1tzdGF0ZS5pbmRleF1cbiAgICAgIDogc3RhdGUucm91dGVzW3N0YXRlLnJvdXRlcy5sZW5ndGggLSAxXTtcblxuICBpZiAocm91dGUuc3RhdGUpIHtcbiAgICByZXR1cm4gZ2V0QWN0aXZlUm91dGUocm91dGUuc3RhdGUpO1xuICB9XG5cbiAgcmV0dXJuIHJvdXRlO1xufTtcblxuLyoqXG4gKiBVdGlsaXR5IHRvIHNlcmlhbGl6ZSBhIG5hdmlnYXRpb24gc3RhdGUgb2JqZWN0IHRvIGEgcGF0aCBzdHJpbmcuXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYGpzXG4gKiBnZXRQYXRoRnJvbVN0YXRlKFxuICogICB7XG4gKiAgICAgcm91dGVzOiBbXG4gKiAgICAgICB7XG4gKiAgICAgICAgIG5hbWU6ICdDaGF0JyxcbiAqICAgICAgICAgcGFyYW1zOiB7IGF1dGhvcjogJ0phbmUnLCBpZDogNDIgfSxcbiAqICAgICAgIH0sXG4gKiAgICAgXSxcbiAqICAgfSxcbiAqICAge1xuICogICAgIHNjcmVlbnM6IHtcbiAqICAgICAgIENoYXQ6IHtcbiAqICAgICAgICAgcGF0aDogJ2NoYXQvOmF1dGhvci86aWQnLFxuICogICAgICAgICBzdHJpbmdpZnk6IHsgYXV0aG9yOiBhdXRob3IgPT4gYXV0aG9yLnRvTG93ZXJDYXNlKCkgfVxuICogICAgICAgfVxuICogICAgIH1cbiAqICAgfVxuICogKVxuICogYGBgXG4gKlxuICogQHBhcmFtIHN0YXRlIE5hdmlnYXRpb24gc3RhdGUgdG8gc2VyaWFsaXplLlxuICogQHBhcmFtIG9wdGlvbnMgRXh0cmEgb3B0aW9ucyB0byBmaW5lLXR1bmUgaG93IHRvIHNlcmlhbGl6ZSB0aGUgcGF0aC5cbiAqIEByZXR1cm5zIFBhdGggcmVwcmVzZW50aW5nIHRoZSBzdGF0ZSwgZS5nLiAvZm9vL2Jhcj9jb3VudD00Mi5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZ2V0UGF0aEZyb21TdGF0ZTxQYXJhbUxpc3QgZXh0ZW5kcyB7fT4oXG4gIHN0YXRlOiBTdGF0ZSxcbiAgb3B0aW9ucz86IE9wdGlvbnM8UGFyYW1MaXN0PlxuKTogc3RyaW5nIHtcbiAgaWYgKHN0YXRlID09IG51bGwpIHtcbiAgICB0aHJvdyBFcnJvcihcbiAgICAgIFwiR290ICd1bmRlZmluZWQnIGZvciB0aGUgbmF2aWdhdGlvbiBzdGF0ZS4gWW91IG11c3QgcGFzcyBhIHZhbGlkIHN0YXRlIG9iamVjdC5cIlxuICAgICk7XG4gIH1cblxuICBpZiAob3B0aW9ucykge1xuICAgIHZhbGlkYXRlUGF0aENvbmZpZyhvcHRpb25zKTtcbiAgfVxuXG4gIC8vIENyZWF0ZSBhIG5vcm1hbGl6ZWQgY29uZmlncyBvYmplY3Qgd2hpY2ggd2lsbCBiZSBlYXNpZXIgdG8gdXNlXG4gIGNvbnN0IGNvbmZpZ3M6IFJlY29yZDxzdHJpbmcsIENvbmZpZ0l0ZW0+ID0gb3B0aW9ucz8uc2NyZWVuc1xuICAgID8gY3JlYXRlTm9ybWFsaXplZENvbmZpZ3Mob3B0aW9ucz8uc2NyZWVucylcbiAgICA6IHt9O1xuXG4gIGxldCBwYXRoID0gJy8nO1xuICBsZXQgY3VycmVudDogU3RhdGUgfCB1bmRlZmluZWQgPSBzdGF0ZTtcblxuICBjb25zdCBhbGxQYXJhbXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcblxuICB3aGlsZSAoY3VycmVudCkge1xuICAgIGxldCBpbmRleCA9IHR5cGVvZiBjdXJyZW50LmluZGV4ID09PSAnbnVtYmVyJyA/IGN1cnJlbnQuaW5kZXggOiAwO1xuICAgIGxldCByb3V0ZSA9IGN1cnJlbnQucm91dGVzW2luZGV4XSBhcyBSb3V0ZTxzdHJpbmc+ICYge1xuICAgICAgc3RhdGU/OiBTdGF0ZTtcbiAgICB9O1xuXG4gICAgbGV0IHBhdHRlcm46IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAgIGxldCBmb2N1c2VkUGFyYW1zOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkO1xuICAgIGxldCBmb2N1c2VkUm91dGUgPSBnZXRBY3RpdmVSb3V0ZShzdGF0ZSk7XG4gICAgbGV0IGN1cnJlbnRPcHRpb25zID0gY29uZmlncztcblxuICAgIC8vIEtlZXAgYWxsIHRoZSByb3V0ZSBuYW1lcyB0aGF0IGFwcGVhcmVkIGR1cmluZyBnb2luZyBkZWVwZXIgaW4gY29uZmlnIGluIGNhc2UgdGhlIHBhdHRlcm4gaXMgcmVzb2x2ZWQgdG8gdW5kZWZpbmVkXG4gICAgbGV0IG5lc3RlZFJvdXRlTmFtZXMgPSBbXTtcblxuICAgIGxldCBoYXNOZXh0ID0gdHJ1ZTtcblxuICAgIHdoaWxlIChyb3V0ZS5uYW1lIGluIGN1cnJlbnRPcHRpb25zICYmIGhhc05leHQpIHtcbiAgICAgIHBhdHRlcm4gPSBjdXJyZW50T3B0aW9uc1tyb3V0ZS5uYW1lXS5wYXR0ZXJuO1xuXG4gICAgICBuZXN0ZWRSb3V0ZU5hbWVzLnB1c2gocm91dGUubmFtZSk7XG5cbiAgICAgIGlmIChyb3V0ZS5wYXJhbXMpIHtcbiAgICAgICAgY29uc3Qgc3RyaW5naWZ5ID0gY3VycmVudE9wdGlvbnNbcm91dGUubmFtZV0/LnN0cmluZ2lmeTtcblxuICAgICAgICBjb25zdCBjdXJyZW50UGFyYW1zID0gZnJvbUVudHJpZXMoXG4gICAgICAgICAgT2JqZWN0LmVudHJpZXMocm91dGUucGFyYW1zKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gW1xuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgc3RyaW5naWZ5Py5ba2V5XSA/IHN0cmluZ2lmeVtrZXldKHZhbHVlKSA6IFN0cmluZyh2YWx1ZSksXG4gICAgICAgICAgXSlcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAocGF0dGVybikge1xuICAgICAgICAgIE9iamVjdC5hc3NpZ24oYWxsUGFyYW1zLCBjdXJyZW50UGFyYW1zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChmb2N1c2VkUm91dGUgPT09IHJvdXRlKSB7XG4gICAgICAgICAgLy8gSWYgdGhpcyBpcyB0aGUgZm9jdXNlZCByb3V0ZSwga2VlcCB0aGUgcGFyYW1zIGZvciBsYXRlciB1c2VcbiAgICAgICAgICAvLyBXZSBzYXZlIGl0IGhlcmUgc2luY2UgaXQncyBiZWVuIHN0cmluZ2lmaWVkIGFscmVhZHlcbiAgICAgICAgICBmb2N1c2VkUGFyYW1zID0geyAuLi5jdXJyZW50UGFyYW1zIH07XG5cbiAgICAgICAgICBwYXR0ZXJuXG4gICAgICAgICAgICA/LnNwbGl0KCcvJylcbiAgICAgICAgICAgIC5maWx0ZXIoKHApID0+IHAuc3RhcnRzV2l0aCgnOicpKVxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWxvb3AtZnVuY1xuICAgICAgICAgICAgLmZvckVhY2goKHApID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IGdldFBhcmFtTmFtZShwKTtcblxuICAgICAgICAgICAgICAvLyBSZW1vdmUgdGhlIHBhcmFtcyBwcmVzZW50IGluIHRoZSBwYXR0ZXJuIHNpbmNlIHdlJ2xsIG9ubHkgdXNlIHRoZSByZXN0IGZvciBxdWVyeSBzdHJpbmdcbiAgICAgICAgICAgICAgaWYgKGZvY3VzZWRQYXJhbXMpIHtcbiAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWR5bmFtaWMtZGVsZXRlXG4gICAgICAgICAgICAgICAgZGVsZXRlIGZvY3VzZWRQYXJhbXNbbmFtZV07XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIElmIHRoZXJlIGlzIG5vIGBzY3JlZW5zYCBwcm9wZXJ0eSBvciBubyBuZXN0ZWQgc3RhdGUsIHdlIHJldHVybiBwYXR0ZXJuXG4gICAgICBpZiAoIWN1cnJlbnRPcHRpb25zW3JvdXRlLm5hbWVdLnNjcmVlbnMgfHwgcm91dGUuc3RhdGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBoYXNOZXh0ID0gZmFsc2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbmRleCA9XG4gICAgICAgICAgdHlwZW9mIHJvdXRlLnN0YXRlLmluZGV4ID09PSAnbnVtYmVyJ1xuICAgICAgICAgICAgPyByb3V0ZS5zdGF0ZS5pbmRleFxuICAgICAgICAgICAgOiByb3V0ZS5zdGF0ZS5yb3V0ZXMubGVuZ3RoIC0gMTtcblxuICAgICAgICBjb25zdCBuZXh0Um91dGUgPSByb3V0ZS5zdGF0ZS5yb3V0ZXNbaW5kZXhdO1xuICAgICAgICBjb25zdCBuZXN0ZWRDb25maWcgPSBjdXJyZW50T3B0aW9uc1tyb3V0ZS5uYW1lXS5zY3JlZW5zO1xuXG4gICAgICAgIC8vIGlmIHRoZXJlIGlzIGNvbmZpZyBmb3IgbmV4dCByb3V0ZSBuYW1lLCB3ZSBnbyBkZWVwZXJcbiAgICAgICAgaWYgKG5lc3RlZENvbmZpZyAmJiBuZXh0Um91dGUubmFtZSBpbiBuZXN0ZWRDb25maWcpIHtcbiAgICAgICAgICByb3V0ZSA9IG5leHRSb3V0ZSBhcyBSb3V0ZTxzdHJpbmc+ICYgeyBzdGF0ZT86IFN0YXRlIH07XG4gICAgICAgICAgY3VycmVudE9wdGlvbnMgPSBuZXN0ZWRDb25maWc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gSWYgbm90LCB0aGVyZSBpcyBubyBzZW5zZSBpbiBnb2luZyBkZWVwZXIgaW4gY29uZmlnXG4gICAgICAgICAgaGFzTmV4dCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHBhdHRlcm4gPT09IHVuZGVmaW5lZCkge1xuICAgICAgcGF0dGVybiA9IG5lc3RlZFJvdXRlTmFtZXMuam9pbignLycpO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50T3B0aW9uc1tyb3V0ZS5uYW1lXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwYXRoICs9IHBhdHRlcm5cbiAgICAgICAgLnNwbGl0KCcvJylcbiAgICAgICAgLm1hcCgocCkgPT4ge1xuICAgICAgICAgIGNvbnN0IG5hbWUgPSBnZXRQYXJhbU5hbWUocCk7XG5cbiAgICAgICAgICAvLyBXZSBkb24ndCBrbm93IHdoYXQgdG8gc2hvdyBmb3Igd2lsZGNhcmQgcGF0dGVybnNcbiAgICAgICAgICAvLyBTaG93aW5nIHRoZSByb3V0ZSBuYW1lIHNlZW1zIG9rLCB0aG91Z2ggd2hhdGV2ZXIgd2Ugc2hvdyBoZXJlIHdpbGwgYmUgaW5jb3JyZWN0XG4gICAgICAgICAgLy8gU2luY2UgdGhlIHBhZ2UgZG9lc24ndCBhY3R1YWxseSBleGlzdFxuICAgICAgICAgIGlmIChwID09PSAnKicpIHtcbiAgICAgICAgICAgIHJldHVybiByb3V0ZS5uYW1lO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIElmIHRoZSBwYXRoIGhhcyBhIHBhdHRlcm4gZm9yIGEgcGFyYW0sIHB1dCB0aGUgcGFyYW0gaW4gdGhlIHBhdGhcbiAgICAgICAgICBpZiAocC5zdGFydHNXaXRoKCc6JykpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gYWxsUGFyYW1zW25hbWVdO1xuXG4gICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCAmJiBwLmVuZHNXaXRoKCc/JykpIHtcbiAgICAgICAgICAgICAgLy8gT3B0aW9uYWwgcGFyYW1zIHdpdGhvdXQgdmFsdWUgYXNzaWduZWQgaW4gcm91dGUucGFyYW1zIHNob3VsZCBiZSBpZ25vcmVkXG4gICAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChwKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmpvaW4oJy8nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGF0aCArPSBlbmNvZGVVUklDb21wb25lbnQocm91dGUubmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKCFmb2N1c2VkUGFyYW1zKSB7XG4gICAgICBmb2N1c2VkUGFyYW1zID0gZm9jdXNlZFJvdXRlLnBhcmFtcztcbiAgICB9XG5cbiAgICBpZiAocm91dGUuc3RhdGUpIHtcbiAgICAgIHBhdGggKz0gJy8nO1xuICAgIH0gZWxzZSBpZiAoZm9jdXNlZFBhcmFtcykge1xuICAgICAgZm9yIChsZXQgcGFyYW0gaW4gZm9jdXNlZFBhcmFtcykge1xuICAgICAgICBpZiAoZm9jdXNlZFBhcmFtc1twYXJhbV0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1keW5hbWljLWRlbGV0ZVxuICAgICAgICAgIGRlbGV0ZSBmb2N1c2VkUGFyYW1zW3BhcmFtXTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBxdWVyeSA9IHF1ZXJ5U3RyaW5nLnN0cmluZ2lmeShmb2N1c2VkUGFyYW1zLCB7IHNvcnQ6IGZhbHNlIH0pO1xuXG4gICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgcGF0aCArPSBgPyR7cXVlcnl9YDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjdXJyZW50ID0gcm91dGUuc3RhdGU7XG4gIH1cblxuICAvLyBSZW1vdmUgbXVsdGlwbGUgYXMgd2VsbCBhcyB0cmFpbGluZyBzbGFzaGVzXG4gIHBhdGggPSBwYXRoLnJlcGxhY2UoL1xcLysvZywgJy8nKTtcbiAgcGF0aCA9IHBhdGgubGVuZ3RoID4gMSA/IHBhdGgucmVwbGFjZSgvXFwvJC8sICcnKSA6IHBhdGg7XG5cbiAgcmV0dXJuIHBhdGg7XG59XG5cbmNvbnN0IGdldFBhcmFtTmFtZSA9IChwYXR0ZXJuOiBzdHJpbmcpID0+XG4gIHBhdHRlcm4ucmVwbGFjZSgvXjovLCAnJykucmVwbGFjZSgvXFw/JC8sICcnKTtcblxuY29uc3Qgam9pblBhdGhzID0gKC4uLnBhdGhzOiBzdHJpbmdbXSk6IHN0cmluZyA9PlxuICAoW10gYXMgc3RyaW5nW10pXG4gICAgLmNvbmNhdCguLi5wYXRocy5tYXAoKHApID0+IHAuc3BsaXQoJy8nKSkpXG4gICAgLmZpbHRlcihCb29sZWFuKVxuICAgIC5qb2luKCcvJyk7XG5cbmNvbnN0IGNyZWF0ZUNvbmZpZ0l0ZW0gPSAoXG4gIGNvbmZpZzogUGF0aENvbmZpZzxvYmplY3Q+IHwgc3RyaW5nLFxuICBwYXJlbnRQYXR0ZXJuPzogc3RyaW5nXG4pOiBDb25maWdJdGVtID0+IHtcbiAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdzdHJpbmcnKSB7XG4gICAgLy8gSWYgYSBzdHJpbmcgaXMgc3BlY2lmaWVkIGFzIHRoZSB2YWx1ZSBvZiB0aGUga2V5KGUuZy4gRm9vOiAnL3BhdGgnKSwgdXNlIGl0IGFzIHRoZSBwYXR0ZXJuXG4gICAgY29uc3QgcGF0dGVybiA9IHBhcmVudFBhdHRlcm4gPyBqb2luUGF0aHMocGFyZW50UGF0dGVybiwgY29uZmlnKSA6IGNvbmZpZztcblxuICAgIHJldHVybiB7IHBhdHRlcm4gfTtcbiAgfVxuXG4gIC8vIElmIGFuIG9iamVjdCBpcyBzcGVjaWZpZWQgYXMgdGhlIHZhbHVlIChlLmcuIEZvbzogeyAuLi4gfSksXG4gIC8vIEl0IGNhbiBoYXZlIGBwYXRoYCBwcm9wZXJ0eSBhbmQgYHNjcmVlbnNgIHByb3Agd2hpY2ggaGFzIG5lc3RlZCBjb25maWdzXG4gIGxldCBwYXR0ZXJuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgaWYgKGNvbmZpZy5leGFjdCAmJiBjb25maWcucGF0aCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgXCJBICdwYXRoJyBuZWVkcyB0byBiZSBzcGVjaWZpZWQgd2hlbiBzcGVjaWZ5aW5nICdleGFjdDogdHJ1ZScuIElmIHlvdSBkb24ndCB3YW50IHRoaXMgc2NyZWVuIGluIHRoZSBVUkwsIHNwZWNpZnkgaXQgYXMgZW1wdHkgc3RyaW5nLCBlLmcuIGBwYXRoOiAnJ2AuXCJcbiAgICApO1xuICB9XG5cbiAgcGF0dGVybiA9XG4gICAgY29uZmlnLmV4YWN0ICE9PSB0cnVlXG4gICAgICA/IGpvaW5QYXRocyhwYXJlbnRQYXR0ZXJuIHx8ICcnLCBjb25maWcucGF0aCB8fCAnJylcbiAgICAgIDogY29uZmlnLnBhdGggfHwgJyc7XG5cbiAgY29uc3Qgc2NyZWVucyA9IGNvbmZpZy5zY3JlZW5zXG4gICAgPyBjcmVhdGVOb3JtYWxpemVkQ29uZmlncyhjb25maWcuc2NyZWVucywgcGF0dGVybilcbiAgICA6IHVuZGVmaW5lZDtcblxuICByZXR1cm4ge1xuICAgIC8vIE5vcm1hbGl6ZSBwYXR0ZXJuIHRvIHJlbW92ZSBhbnkgbGVhZGluZywgdHJhaWxpbmcgc2xhc2hlcywgZHVwbGljYXRlIHNsYXNoZXMgZXRjLlxuICAgIHBhdHRlcm46IHBhdHRlcm4/LnNwbGl0KCcvJykuZmlsdGVyKEJvb2xlYW4pLmpvaW4oJy8nKSxcbiAgICBzdHJpbmdpZnk6IGNvbmZpZy5zdHJpbmdpZnksXG4gICAgc2NyZWVucyxcbiAgfTtcbn07XG5cbmNvbnN0IGNyZWF0ZU5vcm1hbGl6ZWRDb25maWdzID0gKFxuICBvcHRpb25zOiBQYXRoQ29uZmlnTWFwPG9iamVjdD4sXG4gIHBhdHRlcm4/OiBzdHJpbmdcbik6IFJlY29yZDxzdHJpbmcsIENvbmZpZ0l0ZW0+ID0+XG4gIGZyb21FbnRyaWVzKFxuICAgIE9iamVjdC5lbnRyaWVzKG9wdGlvbnMpLm1hcCgoW25hbWUsIGNdKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBjcmVhdGVDb25maWdJdGVtKGMsIHBhdHRlcm4pO1xuXG4gICAgICByZXR1cm4gW25hbWUsIHJlc3VsdF07XG4gICAgfSlcbiAgKTtcbiJdfQ==